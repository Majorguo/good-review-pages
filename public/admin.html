<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>后台管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 10px;
  background: #f0f0f0;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
}

/* 登录 */
#loginDiv {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 40px;
}
#loginDiv input,
#loginDiv button {
  width: 240px;
  font-size: 18px;
}
#loginDiv input {
  height: 44px;
  margin-bottom: 12px;
}
#loginDiv button {
  height: 54px;
}

/* 管理区容器 */
#adminDiv {
  width: 100%;
  max-width: 600px;        /* PC 限制宽度 */
  margin: 0 auto;
  display: none;
  flex-direction: column;
  gap: 12px;
}

/* 文本框 */
#newReview {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  resize: none;
  box-sizing: border-box;
  overflow-y: auto;
}

/* 添加按钮 */
#addBtn {
  width: 100%;
  padding: 14px;
  font-size: 18px;
}

/* 列表 */
.review-item {
  display: flex;
  flex-wrap: wrap;
  background: #fff;
  padding: 10px;
  border-radius: 6px;
}
.review-text {
  flex: 1;
  white-space: pre-wrap;
  word-break: break-word;
}
.review-buttons {
  display: flex;
  gap: 6px;
  margin-top: 6px;
}
.review-buttons button {
  font-size: 14px;
  padding: 6px 10px;
}

#feedback {
  color: green;
}
</style>
</head>

<body>

<h1>好评后台管理</h1>

<!-- 登录 -->
<div id="loginDiv">
  <input type="password" id="passwordInput" placeholder="请输入管理员密码">
  <button id="loginBtn">登录</button>
</div>

<!-- 管理 -->
<div id="adminDiv">
  <textarea id="newReview" placeholder="输入新好评"></textarea>
  <button id="addBtn">添加好评</button>
  <div id="feedback"></div>
  <div id="reviewList"></div>
</div>

<script>
const newReview = document.getElementById('newReview');
const adminDiv = document.getElementById('adminDiv');

/* 判断是否手机 */
function isMobile() {
  return window.innerWidth <= 768;
}

/* 核心：正确计算高度 */
function adjustTextareaSize() {
  const width = newReview.offsetWidth;
  if (!width) return;

  if (isMobile()) {
    // 手机：1:1
    newReview.style.height = width + 'px';
  } else {
    // PC：3:2 比例，防止过大
    newReview.style.height = Math.floor(width * 0.66) + 'px';
  }

  // 内容超出自动撑高
  if (newReview.scrollHeight > newReview.offsetHeight) {
    newReview.style.height = newReview.scrollHeight + 'px';
  }
}

/* 输入时自适应 */
newReview.addEventListener('input', () => {
  adjustTextareaSize();
});

/* resize */
window.addEventListener('resize', () => {
  adjustTextareaSize();
});

/* 显示后台（关键：显示后再算尺寸） */
function showAdmin() {
  document.getElementById('loginDiv').style.display = 'none';
  adminDiv.style.display = 'flex';

  // 等浏览器完成一次渲染再算
  requestAnimationFrame(() => {
    adjustTextareaSize();
  });

  loadAdminReviews();
}

/* 自动登录 */
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('ADMIN_TOKEN');
  if (saved) {
    window.ADMIN_TOKEN = saved;
    showAdmin();
  }
});

/* 登录 */
document.getElementById('loginBtn').onclick = () => {
  const pwd = passwordInput.value.trim();
  if (!pwd) return alert('请输入密码');

  window.ADMIN_TOKEN = pwd;
  localStorage.setItem('ADMIN_TOKEN', pwd);
  showAdmin();
};

/* 添加 */
addBtn.onclick = async () => {
  const content = newReview.value.trim();
  if (!content) return alert('请输入内容');

  const res = await fetch('/api/add', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ content, token: window.ADMIN_TOKEN })
  });

  const r = await res.json();
  if (res.ok) {
    newReview.value = '';
    adjustTextareaSize();
    loadAdminReviews();
  } else {
    alert(r.error || r.message);
  }
};

/* 列表 */
async function loadAdminReviews() {
  const box = reviewList;
  box.innerHTML = '加载中...';

  const res = await fetch('/api/list');
  const data = await res.json();

  box.innerHTML = '';
  data
    .filter(i => !i.deleted)
    .sort((a,b)=>{
      const ta = a.updated_at || a.created_at;
      const tb = b.updated_at || b.created_at;
      return new Date(tb) - new Date(ta);
    })
    .forEach(item=>{
      const div = document.createElement('div');
      div.className = 'review-item';
      div.innerHTML = `
        <div class="review-text">${item.content}</div>
        <div class="review-buttons">
          <button onclick="adminDelete('${item.id}')">删除</button>
          <button onclick="adminEdit('${item.id}','${encodeURIComponent(item.content)}')">修改</button>
        </div>
      `;
      box.appendChild(div);
    });
}

/* 删除 / 修改 保持不变 */
</script>

</body>
</html>
