<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>好评展示</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 10px;
    background: #f9f9f9;
  }

  h1 { text-align: center; margin-bottom: 15px; }

  .review-section {
    max-width: 600px;
    margin: 0 auto 20px auto;
    background: #eaeaea;
    padding: 10px;
    border-radius: 6px;
  }

  .review-section h2 {
    margin-bottom: 10px;
    font-size: 18px;
  }

  .review-list {
    max-height: 250px; /* 固定父容器高度 */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .review-item {
    background: #fff;
    padding: 8px;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .review-text {
    width: 100%;
    padding: 6px;
    border: none;
    background: transparent;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    resize: none;
    overflow: hidden; /* 内容自适应，不滚动 */
    white-space: pre-wrap;
    word-break: break-word;
  }

  .review-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .review-buttons button {
    padding: 5px 12px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: #f2f2f2;
    cursor: pointer;
  }
  .review-buttons button:active { background: #e0e0e0; }
</style>
</head>
<body>

<h1>好评展示</h1>

<!-- 手机贴膜 -->
<div class="review-section" id="section-film">
  <h2>手机贴膜好评</h2>
  <div class="review-list" id="list-film">加载中...</div>
</div>

<!-- 更换电池 -->
<div class="review-section" id="section-battery">
  <h2>更换电池好评</h2>
  <div class="review-list" id="list-battery">加载中...</div>
</div>

<script>
async function loadReviews() {
  try {
    const res = await fetch('/api/list');
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      document.getElementById('list-film').innerHTML = '<p>暂无好评</p>';
      document.getElementById('list-battery').innerHTML = '<p>暂无好评</p>';
      return;
    }

    const filmReviews = data
      .filter(item => !item.deleted && item.category === '膜')
      .sort((a, b) => Number(a.id) - Number(b.id))
      .slice(0, 3);

    const batteryReviews = data
      .filter(item => !item.deleted && item.category === '电池')
      .sort((a, b) => Number(a.id) - Number(b.id))
      .slice(0, 3);

    renderList('list-film', filmReviews);
    renderList('list-battery', batteryReviews);
  } catch(e) {
    document.getElementById('list-film').innerHTML = '加载失败：' + e.message;
    document.getElementById('list-battery').innerHTML = '加载失败：' + e.message;
  }
}

function renderList(containerId, reviews) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  if (!reviews.length) {
    container.innerHTML = '<p>暂无好评</p>';
    return;
  }

  reviews.forEach(item => {
    const div = document.createElement('div');
    div.className = 'review-item';
    const textarea = document.createElement('textarea');
    textarea.className = 'review-text';
    textarea.readOnly = true;
    textarea.value = item.content;

    // 自动调整高度
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'review-buttons';
    buttonsDiv.innerHTML = `
      <button onclick="copyReview('${encodeURIComponent(item.content)}')">复制</button>
      <button onclick="deleteReview('${item.id}')">删除</button>
    `;

    div.appendChild(textarea);
    div.appendChild(buttonsDiv);
    container.appendChild(div);
  });
}

function copyReview(content) {
  const text = decodeURIComponent(content);
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(()=>showToast('已复制')).catch(()=>fallbackCopy(text));
  } else fallbackCopy(text);
}

function fallbackCopy(text) {
  const temp = document.createElement('textarea');
  temp.value = text;
  document.body.appendChild(temp);
  temp.select();
  document.execCommand('copy');
  document.body.removeChild(temp);
  showToast('已复制');
}

async function deleteReview(id) {
  try {
    const res = await fetch('/api/delete',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({id})
    });
    const data = await res.json();
    if(res.ok) loadReviews();
    else alert('删除失败：'+ (data.error||data.message));
  } catch(e){
    alert('删除失败：'+ e.message);
  }
}

function showToast(text){
  const toast = document.createElement('div');
  toast.innerText = text;
  toast.style.cssText=`
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 9999;
  `;
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),1500);
}

loadReviews();
</script>

</body>
</html>
